name: Deploy to Staging

on:
  push:
    branches: [main]
    paths:
      - 'terraform/test-files/**'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even without changes'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: us-west-2

jobs:
  build:
    uses: ./.github/workflows/build.yml

  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: website-build-${{ github.sha }}
          path: dist/

      - name: Get S3 bucket name from Terraform
        id: get-bucket
        run: |
          echo "ðŸ” Getting S3 bucket name for staging..."
          
          # Try to get bucket name from Terraform output
          # This assumes the Terraform workspace outputs are available
          BUCKET_NAME=$(aws s3api list-buckets --query "Buckets[?contains(Name, 'portfolio-staging')].Name" --output text)
          
          if [ -z "$BUCKET_NAME" ]; then
            # Fallback to expected naming pattern
            BUCKET_NAME="portfolio-staging-$(date +%Y%m%d)"
            echo "âš ï¸ Could not detect bucket name, using fallback: $BUCKET_NAME"
          else
            echo "âœ… Found staging bucket: $BUCKET_NAME"
          fi
          
          echo "bucket-name=$BUCKET_NAME" >> $GITHUB_OUTPUT

      - name: Deploy to S3
        run: |
          echo "ðŸš€ Deploying website to S3 staging bucket..."
          
          BUCKET_NAME="${{ steps.get-bucket.outputs.bucket-name }}"
          
          # Sync files to S3 with appropriate settings
          aws s3 sync dist/ s3://$BUCKET_NAME/ \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "*.html" \
            --exclude "*.json"
          
          # Upload HTML files with shorter cache (for faster updates)
          aws s3 sync dist/ s3://$BUCKET_NAME/ \
            --delete \
            --cache-control "public, max-age=300" \
            --include "*.html" \
            --include "*.json"
          
          echo "âœ… Website files deployed to S3"

      - name: Get CloudFront distribution ID
        id: get-cloudfront
        run: |
          echo "ðŸ” Getting CloudFront distribution ID for staging..."
          
          BUCKET_NAME="${{ steps.get-bucket.outputs.bucket-name }}"
          
          # Get CloudFront distribution ID for this S3 bucket
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?contains(Origins.Items[0].DomainName, '$BUCKET_NAME')].Id" \
            --output text)
          
          if [ -z "$DISTRIBUTION_ID" ]; then
            echo "âš ï¸ Could not find CloudFront distribution for bucket: $BUCKET_NAME"
            echo "distribution-id=" >> $GITHUB_OUTPUT
          else
            echo "âœ… Found CloudFront distribution: $DISTRIBUTION_ID"
            echo "distribution-id=$DISTRIBUTION_ID" >> $GITHUB_OUTPUT
          fi

      - name: Invalidate CloudFront cache
        if: steps.get-cloudfront.outputs.distribution-id != ''
        run: |
          echo "ðŸ”„ Invalidating CloudFront cache..."
          
          DISTRIBUTION_ID="${{ steps.get-cloudfront.outputs.distribution-id }}"
          
          # Create invalidation for all files
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*" \
            --query "Invalidation.Id" \
            --output text)
          
          echo "âœ… CloudFront invalidation created: $INVALIDATION_ID"
          echo "â³ Invalidation may take 10-15 minutes to complete"

      - name: Verify deployment
        run: |
          echo "ðŸ§ª Verifying staging deployment..."
          
          BUCKET_NAME="${{ steps.get-bucket.outputs.bucket-name }}"
          
          # Check if index.html exists and is accessible
          if aws s3 ls s3://$BUCKET_NAME/index.html; then
            echo "âœ… index.html successfully deployed"
          else
            echo "âŒ index.html not found in S3 bucket"
            exit 1
          fi
          
          # Get the website URL from bucket info
          REGION=$(aws s3api get-bucket-location --bucket $BUCKET_NAME --query "LocationConstraint" --output text)
          if [ "$REGION" = "None" ]; then
            REGION="us-east-1"
          fi
          
          WEBSITE_URL="http://$BUCKET_NAME.s3-website-$REGION.amazonaws.com"
          echo "ðŸŒ Staging website URL: $WEBSITE_URL"
          
          # Test if website is accessible (basic HTTP check)
          if curl -f -s $WEBSITE_URL > /dev/null; then
            echo "âœ… Staging website is accessible"
          else
            echo "âš ï¸ Website may not be immediately accessible (this is normal)"
          fi

      - name: Deployment Summary
        run: |
          echo "## ðŸŽ‰ Staging Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Website has been successfully deployed to staging!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Deployment Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: \`staging\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit SHA**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **S3 Bucket**: \`${{ steps.get-bucket.outputs.bucket-name }}\`" >> $GITHUB_STEP_SUMMARY
          
          if [ -n "${{ steps.get-cloudfront.outputs.distribution-id }}" ]; then
            echo "- **CloudFront Distribution**: \`${{ steps.get-cloudfront.outputs.distribution-id }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Cache Invalidation**: âœ… Initiated" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **CloudFront Distribution**: âš ï¸ Not found" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Access Your Site" >> $GITHUB_STEP_SUMMARY
          echo "Your staging website will be available shortly at the configured CloudFront URL." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: Cache invalidation may take 10-15 minutes to complete." >> $GITHUB_STEP_SUMMARY 